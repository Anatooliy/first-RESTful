@{
    ViewBag.Title = "Books store";
}

<h2>Books store</h2>

<div class="row">
    <p style="color:red">I will finish it today (17.11.2018)</p>
    <div id="genres" class="col-md-12">
        @using (Html.BeginForm())
        {
            <div class="form-group">
                <label for="exampleFormControlSelect1">Выберите жанр</label>
                <select class="form-control" id="genre-list"></select>
            </div>
        }
    </div>
    <div id="books-list" class="col-md-12">
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th>Название</th>                    
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        $(document).ready(function () {
            GetAllGenres();
            GetAllBooks();

            $(document).on("click", ".js-button-detail", function () {
                var id = $(this).data("item");
                GetDetailBookInfo(id);
            });

            $(document).on("click", ".js-button-delete", function () {
                var id = $(this).data("item");
                DeleteBook(id);
            });
            
        });

        // Получение всех книг по ajax-запросу
        function GetAllBooks() {
            $.ajax({
                url: '/api/books',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    WriteBooksResponse(data);
                },
                error: function (x, y, z) {
                    alert(x + '\n' + y + '\n' + z);
                }
            });
        }

        // Получение всех жанров по ajax-запросу
        function GetAllGenres() {
            $.ajax({
                url: '/api/genres',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    WriteGenreResponse(data);
                },
                error: function (x, y, z) {
                    alert(x + '\n' + y + '\n' + z);
                }
            });
        }

        // Получение информации о книге
        function GetDetailBookInfo(bookId) {
            $.ajax({
                url: '/api/books/' + bookId,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    WriteDetailBooksResponse(data);
                },
                error: function (x, y, z) {
                    alert(x + '\n' + y + '\n' + z);
                }
            });
        }

        // вывод полученных книг на экран
        function WriteBooksResponse(books) {
            var strResult;
            if (books.length > 0) {
                $.each(books, function (index, book) {
                    strResult += "<tr>";
                    strResult += "<td>" + book.BookName + "</td>"
                        + "<td><button type='button' data-item='" + book.BookId + "' class='js-button-detail btn btn-info btn-l' data-toggle='modal' data-target='#myModal'>Подробнее</button></td>"
                        + "<td><button type='button' data-item='" + book.BookId + "' class='js-button-edit btn btn-warning btn-l' data-toggle='modal' data-target='#myModal'>Редактировать</button></td>"
                        + "<td><button type='button' data-item='" + book.BookId + "' class='js-button-delete btn btn-dark btn-l'>Удалить</button></td>"
                        + "</tr>";
                });
                $("#books-list").find("tbody").html(strResult);
            }
            else {
                $("#books-list").find("tbody").empty();
            }

        }

        // вывод полученной книги
        function WriteDetailBooksResponse(book) {
            var strResult = "<div>";
                strResult += "<p><b>Название: </b>" + book.BookName + "</p>"
                    + "<p><b>Автор: </b>" + book.AuthorName + "</p>"
                    + "<p><b>Жанр: </b>" + book.Genre.GenreName + "</p>"
                    + "<p><b>Год издания: </b>" + book.CreateDate + "</p>"
                    + "<p><b>Издательство: </b>" + book.Publisher.PublisherName + "</p>";                    
            strResult += "</div>";
            $(".modal-title").text(book.BookName);
            $(".modal-body").html(strResult);
        }

        // вывод полученных жанров на экран
        function WriteGenreResponse(genres) {
            var strResult = "<option>Выберите жанр</option>";;
            $.each(genres, function (index, genre) {
                strResult += "<option value='" + genre.GenreId + "'>" + genre.GenreName + "</option>";
            });
            $("#genre-list").html(strResult);
        }

        // Удаление книги
        function DeleteBook(id) {
            $.ajax({
                url: '/api/books/' + id,
                type: 'DELETE',
                contentType: "application/json;charset=utf-8",
                success: function (data) {
                    GetAllBooks();
                },
                error: function (x, y, z) {
                    alert(x + '\n' + y + '\n' + z);
                }
            });
        }
    </script>

}